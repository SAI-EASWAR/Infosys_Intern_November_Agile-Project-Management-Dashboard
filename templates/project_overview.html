<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Overview - {{ project.ProjectName }}</title>
    <link rel="stylesheet" href="/static/project_overview.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/flatpickr/4.6.9/flatpickr.min.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/flatpickr/4.6.9/flatpickr.min.css">
</head>
<body>
    <!-- Header Section -->
    <header>
        <div style="display: none;">
            <ion-icon name="person"></ion-icon>
            <ion-icon name="log-out"></ion-icon>
        </div>
        <div class="container">
            <!-- Title -->
            <a href="/" class="back-to-dashboard">
                <i class="fas fa-arrow-left"></i> Back to Dashboard
            </a>
            <!-- Project Overview Section -->
            <h1 class="project-header">{{ project.ProjectName }} Overview</h1>
            <div class="navigation">
                <div class="user-box">
                    <div class="image-box">
                        <img src="/static/profile-user.png" alt="avatar">
                    </div>
                    <p class="username">{{ session['user_name'] }}</p>
                </div>
                <div class="menu-toggle"></div>
                <ul class="menu">
                    <li>
                      <a href="/profile" class="icon-link">
                        <ion-icon class="menu-icon" name="person-outline" data-filled="person"></ion-icon>Profile
                        <label class="theme-toggle">
                            <input type="checkbox" id="theme-switch">
                            <span class="slider">
                                <i class="fas fa-sun sun-icon"></i>
                                <i class="fas fa-moon moon-icon"></i>
                            </span>
                        </label>
                      </a>
                    </li>
                    <li>
                      <a href="/logout" class="icon-link">
                        <ion-icon class="menu-icon" name="log-out-outline" data-filled="log-out"></ion-icon>Logout
                      </a>
                    </li>
                  </ul>   
                <script>
                    document.addEventListener("DOMContentLoaded", () => {
                        const navigation = document.querySelector('.navigation');
                        const menuToggle = document.querySelector('.menu-toggle');
                        menuToggle.addEventListener('click', () => {
                            navigation.classList.toggle('active');
                        });
            
                        const icons = document.querySelectorAll(".menu-icon");
                        icons.forEach((icon) => {
                            const filledIcon = icon.getAttribute("data-filled"); 
                            const outlineIcon = icon.getAttribute("name"); 
                            icon.parentElement.addEventListener("mouseenter", () => {
                                icon.setAttribute("name", filledIcon);
                            });
                            icon.parentElement.addEventListener("mouseleave", () => {
                                icon.setAttribute("name", outlineIcon);
                            });
                        });
                    });
                </script>
                <script>
                    document.addEventListener("DOMContentLoaded", () => {
                        const themeSwitch = document.getElementById("theme-switch");
                        const htmlElement = document.documentElement;
                
                        // Load and apply saved theme
                        const savedTheme = localStorage.getItem("theme") || "light";
                        htmlElement.setAttribute("data-theme", savedTheme);
                        themeSwitch.checked = savedTheme === "dark";
                
                        // Toggle theme on switch change
                        themeSwitch.addEventListener("change", () => {
                            const newTheme = themeSwitch.checked ? "dark" : "light";
                            htmlElement.setAttribute("data-theme", newTheme);
                            localStorage.setItem("theme", newTheme);
                        });
                    });
                </script>  
            </div>
        </div>
    </header>
    <div id="main-content">
        <div id="left-section">
            <section id="project-manager" class="project-manager-section">
                <p>Product Owner: <strong id="product-owner-name">{{ product_owner.Name }}</strong></p>
            </section>

            <!-- User Stories Table -->
            <section id="user-stories">
                <h2><i class="fas fa-tasks"></i> User Stories</h2>
                <form action="{{ url_for('update_user_story', project_id=project.ProjectID) }}" method="POST">
                    <table>
                        <thead>
                            <tr>
                                <th>User Story</th>
                                <th>Status</th>
                                <th>Assignee</th>
                                <th>MoSCoW</th>
                                <th>Sprint</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for story in user_stories %}
                            <tr class="status-row" data-status="{{ story.Status }}">
                                <td class="user-story-column">{{ story.UserStory }}</td>
                                <!-- Status Cell with Dropdown -->
                                <td>
                                    <select name="status_{{ story.UserStoryID }}" class="status-dropdown">
                                        <option value="In Progress" {% if story.Status == 'In Progress' %}selected{% endif %}>In Progress</option>
                                        <option value="Completed" {% if story.Status == 'Completed' %}selected{% endif %}>Completed</option>
                                        <option value="Not Started" {% if story.Status == 'Not Started' %}selected{% endif %}>Not Started</option>
                                        <option value="On Hold" {% if story.Status == 'On Hold' %}selected{% endif %}>On Hold</option>
                                    </select>
                                </td>
                                <td>
                                    <select class="assignee-dropdown" data-story-id="{{ story.UserStoryID }}">
                                        {% for user in users %}
                                            <option value="{{ user.UserID }}" {% if story.Assignee == user.UserID %}selected{% endif %}>{{ user.UserName }}</option>
                                        {% endfor %}
                                    </select>
                                </td>
                                <td>
                                    <select name="moscow_{{ story.UserStoryID }}" class="moscow-dropdown">
                                        <option value="M" {% if story.Moscow == 'M' %}selected{% endif %}>M</option>
                                        <option value="S" {% if story.Moscow == 'S' %}selected{% endif %}>S</option>
                                        <option value="C" {% if story.Moscow == 'C' %}selected{% endif %}>C</option>
                                        <option value="W" {% if story.Moscow == 'W' %}selected{% endif %}>W</option>
                                    </select>
                                </td>
                                <!-- Sprint Dropdown -->
                                <td>
                                    {% for sprint in sprints %}
                                        {% if sprint.SprintID is not number %}
                                            <input type="number" class="sprint-input" value="" min="1" max="1000">
                                        {% elif sprint.SprintID == story.SprintId %}
                                            <input type="number" class="sprint-input" value="{{ sprint.SprintID }}" min="1" max="1000">
                                        {% endif %}
                                    {% endfor %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>                    
                    </table>
                </form>
            </section>
            
            <!-- Sprint Calendar Section -->
            <section id="sprint-calendar">
                <h2><i class="fas fa-calendar-alt"></i> Sprint Calendar</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Sprint</th>
                            <th>Start Date</th>
                            <th>End Date</th>
                            <th>Due</th>
                            <th>Velocity</th>
                            
                        </tr>
                    </thead>
                    <tbody>
                        {% for sprint in sprints %}
                        <tr>
                            <td>{{ sprint.SprintNo }}</td>
                            <td>
                                <input type="text" class="start-date" value="{{ sprint.StartDate }}" data-sprint-id="{{ sprint.SprintID }}">
                            </td>
                            <td>
                                <input type="text" class="end-date" value="{{ sprint.EndDate }}" data-sprint-id="{{ sprint.SprintID }}">
                            </td>
                            <td class="days-remaining"> 
                                {{ sprint.DaysRemaining }}
                            </td>
                            <td>{{ sprint.TotalStoryPoints }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
                    <script>
                        document.addEventListener('DOMContentLoaded', function() {
                            // Initialize Flatpickr for Start and End Date fields
                            flatpickr(".start-date", {
                                dateFormat: "Y-m-d",  // date format
                                onChange: function(selectedDates, dateStr, instance) {
                                    const sprintId = instance.input.getAttribute('data-sprint-id');
                                    console.log(`Start Date for Sprint ${sprintId} selected: ${dateStr}`);
                                }
                            });

                            flatpickr(".end-date", {
                                dateFormat: "Y-m-d",  //date format
                                onChange: function(selectedDates, dateStr, instance) {
                                    const sprintId = instance.input.getAttribute('data-sprint-id');
                                    console.log(`End Date for Sprint ${sprintId} selected: ${dateStr}`);
                                }
                            });
                        });
                    </script>

                </table>
            </section>
        </div>
        <div id="right-section">
            <!-- Chart Section -->
            <div id="chart-container">
                <section>
                    <h2><i class="fas fa-chart-pie"></i> Charts</h2>
                    <i id="expand-chart-icon" title="Expand"></i>
                    <!-- <div id="chart" style="width: auto; height: auto; border: 1px dashed #ccc; align-items: center; justify-content: center;"> -->
                        <div id="charts-section">
                            <!-- Donut Chart -->
                            <div class="chart-container">
                                <h4>Donut Chart</h4>
                                <i class="expand-icon fas fa-expand" title="Expand"></i>
                                <canvas id="donutChart" width="60" height="60"></canvas>
                            </div>
                            <!-- Burnup Chart -->
                            <div class="chart-container">
                                <h4>Burnup Chart</h4>
                                <i class="expand-icon fas fa-expand" title="Expand"></i>
                                <canvas id="burnupChart" width="60" height="60"></canvas>
                            </div class="chart-container">
                            <!-- Velocity Chart -->
                            <div class="chart-container">
                                <h4>Velocity Chart</h4>
                                <i class="expand-icon fas fa-expand" title="Expand"></i>
                                <canvas id="velocityChart" width="60" height="60"></canvas>
                            </div class="chart-container">
                            <!-- Burndown Chart -->
                            <div class="chart-container">
                                <h4>Burndown Chart</h4>
                                <i class="expand-icon fas fa-expand" title="Expand"></i>
                                <canvas id="burndownChart" width="60" height="60"></canvas>
                            </div>
                            <!-- User Progress Chart -->
                            <div class="chart-container">
                                <h4>User Progress Chart</h4>
                                <i class="expand-icon fas fa-expand" title="Expand"></i>
                                <canvas id="userProgressChart" width="60" height="60"></canvas>
                            </div>
                            <!-- User Ranking Chart -->
                            <div class="chart-container">
                                <h4>User Ranking Chart</h4>
                                <i class="expand-icon fas fa-expand" title="Expand"></i>
                                <canvas id="userRankingChart" width="60" height="60"></canvas>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </div>
    
    <div id="calendar-popup" class="theme-popup">
        <input type="text" id="calendar-input" class="flatpickr" readonly>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/flatpickr/4.6.9/flatpickr.min.js"></script>
    
    <script>
        $(document).ready(function () {
            // Initialize Flatpickr for the popup calendar
            const calendar = flatpickr("#calendar-input", {
                inline: true,
                locale: "en",
                defaultDate: "today", // Default to today
            });
    
            // Function to highlight the hovered date
            function highlightHoveredDate(dateStr) {
                calendar.setDate(dateStr, true); // Update Flatpickr to highlight the date in the cell
            }
    
            // Event handlers for showing and hiding the calendar popup
            $(".date-cell").hover(
                function () {
                    const date = $(this).text().trim(); // Get the date text
                    highlightHoveredDate(date); // Highlight the date on the calendar
    
                    // Position the calendar above the cell
                    const offset = $(this).offset();
                    $("#calendar-popup")
                        .css({
                            top: offset.top - $("#calendar-popup").outerHeight(), // 10px gap above the cell
                            left: offset.left,
                        })
                        .show();
                },
                function () {
                    $("#calendar-popup").hide(); // Hide the calendar when the mouse leaves
                }
            );
        });
    </script>
    
    <script>
        $(document).ready(function () {
        // Function to calculate days remaining
        function calculateDaysRemaining(endDate) {
            const today = new Date();
            const end = new Date(endDate);
            const timeDiff = end - today; // Difference in milliseconds
            const daysRemaining = Math.floor(timeDiff / (1000 * 3600 * 24)); // Convert milliseconds to days
            return daysRemaining;
        }

        // Event listener for changes to the end date
        $(".end-date").on("change", function () {
            const endDate = $(this).val(); // Get the new end date value
            const row = $(this).closest("tr"); // Get the current row
            const daysRemainingCell = row.find(".days-remaining"); // Find the Days Remaining cell

            if (endDate) {
                const daysRemaining = calculateDaysRemaining(endDate);
                daysRemainingCell.text(daysRemaining); // Update the Days Remaining column
                // Apply color coding based on remaining days
                if (daysRemaining >= 0) {
                    daysRemainingCell.css("color", "green"); // Positive values in green
                } else {
                    daysRemainingCell.css("color", "red"); // Negative values in red
                }
            }
        });

        // Initial calculation for all rows
        $('table tbody tr').each(function () {
            const endDate = $(this).find('.end-date').val();
            if (endDate) {
                const daysRemaining = calculateDaysRemaining(endDate);
                const daysRemainingCell = $(this).find(".days-remaining");
                daysRemainingCell.text(daysRemaining); // Update the Days Remaining column
                // Apply color coding
                if (daysRemaining >= 0) {
                    daysRemainingCell.css("color", "green");
                } else {
                    daysRemainingCell.css("color", "red");
                }
            }
        });
    });

    </script>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            // Function to change row color based on the status
            function updateRowColor(row) {
                const status = row.querySelector('.status-dropdown').value.toLowerCase();
                if (status === 'in progress') {
                    row.style.backgroundColor = '#7bf0f0';
                    row.style.color = '#10415e';
                } else if (status === 'completed') {
                    row.style.backgroundColor = '#7dec81';
                    row.style.color = '#037503';
                } else if (status === 'on hold') {
                    row.style.backgroundColor = '#e7af5b';
                    row.style.color = '#5c3d0e';
                } else if (status === 'not started') {
                    row.style.backgroundColor = '#f04f6a';
                    row.style.color = '#5c131f';
                } else {
                    row.style.backgroundColor = ''; // Default
                }
            }
            const rows = document.querySelectorAll('.status-row');
            rows.forEach(function(row) {
                updateRowColor(row); // Initial color setting on page load
            });
            const statusDropdowns = document.querySelectorAll('.status-dropdown');
            statusDropdowns.forEach(function(dropdown) {
                dropdown.addEventListener('change', function() {
                    const row = dropdown.closest('tr'); // Get the row that the dropdown is in
                    updateRowColor(row); // Update row color when dropdown value changes
                });
            });
        });
    </script>

    <!-- /////////////////////////////////////////////////////////////////////// -->
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            // Function to render the Donut Chart
            function renderDonutChart(data) {
                const ctx = document.getElementById("donutChart").getContext("2d");

                new Chart(ctx, {
                    type: "doughnut",
                    data: {
                        labels: data.labels,  // labels (Task Status)
                        datasets: [{
                            data: data.values,  // values (Task counts)
                            backgroundColor: ["#FF6384", "#36A2EB", "#FFCE56"],  // Add more colors if needed
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            tooltip: {
                                callbacks: {
                                    label: function (tooltipItem) {
                                        return tooltipItem.label + ': ' + tooltipItem.raw + ' tasks';  // Display count with "tasks" label
                                    }
                                }
                            }
                        }
                    }
                });
            }

            // Fetch data for donut chart (replace with dynamic project ID if needed)
            fetch('/chart-data/donut/${projectId}')  // Replace with dynamic project ID
                .then(response => response.json())
                .then(data => {
                    renderDonutChart(data);  // Pass the data to the chart rendering function
                })
                .catch(error => console.error('Error fetching data: ', error));


            // Fetch and render Burnup Chart
            function renderBurnupChart(data) {
                const ctx = document.getElementById("burnupChart").getContext("2d");
                new Chart(ctx, {
                    type: "line",
                    data: {
                        labels: data.sprint_ids, // X-axis: Sprint names
                        datasets: [
                            {
                                label: "Total Effort",
                                data: data.total_effort,
                                borderColor: "#36A2EB", // Blue line
                                backgroundColor: "rgba(54,162,235,0.2)",
                                fill: true
                            },
                            {
                                label: "Completed Effort",
                                data: data.completed_data,
                                borderColor: "#4CAF50", // Green line
                                backgroundColor: "rgba(76,175,80,0.2)",
                                fill: true
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { position: 'top' },
                            title: { display: true, text: 'Burnup Chart' }
                        },
                        scales: {
                            x: { title: { display: true, text: 'Sprints' } },
                            y: {
                                title: { display: true, text: 'Story Points' },
                                beginAtZero: true
                            }
                        }
                    }
                });
            }

            // Fetch and render Velocity Chart
            function renderVelocityChart(data) {
                const ctx = document.getElementById("velocityChart").getContext("2d");
                new Chart(ctx, {
                    type: "bar", // Changed to bar chart
                    data: {
                        labels: data.sprint_ids, // Labels for each sprint
                        datasets: [
                            {
                                label: "Total Story Points",
                                data: data.total_data,
                                backgroundColor: "#FFCE56",
                                borderColor: "#FFCE56",
                                borderWidth: 1
                            },
                            {
                                label: "Completed Story Points",
                                data: data.completed_data,
                                backgroundColor: "#4BC0C0",
                                borderColor: "#4BC0C0",
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'top'
                            },
                            title: {
                                display: true,
                                text: 'Velocity Chart'
                            }
                        },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'Sprints'
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'Story Points'
                                },
                                beginAtZero: true
                            }
                        }
                    }
                });
            }


            // Fetch and render Burndown Chart
            function renderBurndownChart(data) {
                const ctx = document.getElementById("burndownChart").getContext("2d");
                new Chart(ctx, {
                    type: "line",
                    data: {
                        labels: data.sprint_ids,
                        datasets: [
                            {
                                label: "Remaining Story Points",
                                data: data.remaining_data,
                                borderColor: "#FF6384",
                                fill: false
                            },
                            {
                                label: "Ideal Burn",
                                data: data.ideal_burn,
                                borderColor: "#36A2EB",
                                borderDash: [5, 5], // Dashed line for ideal burn
                                fill: false
                            }
                        ]
                    }
                });
            }

            // Fetch and render User Progress Chart
            function renderUserProgressChart(data) {
                const ctx = document.getElementById("userProgressChart").getContext("2d");
                new Chart(ctx, {
                    type: "bar",
                    data: {
                        labels: data.user_names,
                        datasets: [
                            {
                                label: "Total Story Points",
                                data: data.total_data,
                                backgroundColor: "#FF6384",
                                borderWidth: 1
                            },
                            {
                                label: "Completed Story Points",
                                data: data.completed_data,
                                backgroundColor: "#36A2EB",
                                borderWidth: 1
                            }
                        ]
                    }
                });
            }

            // Fetch and render User Ranking Chart
            function renderUserRankingChart(data) {
                const ctx = document.getElementById("userRankingChart").getContext("2d");

                // Create a new line chart
                new Chart(ctx, {
                    type: "line", // Change from "bar" to "line"
                    data: {
                        labels: data.completed_user_names, // X-axis labels: User names
                        datasets: [
                            {
                                label: "Completed Story Points", // Label for Completed Story Points
                                data: data.completed_data, // Data for Completed Story Points
                                borderColor: "#FFCE56", // Line color for Completed Story Points
                                fill: false, // Do not fill the area under the line
                                tension: 0.1, // Smooth the line curve
                                borderWidth: 2 // Line thickness
                            },
                            {
                                label: "Total Story Points", // Label for Total Story Points
                                data: data.total_data, // Data for Total Story Points
                                borderColor: "#4BC0C0", // Line color for Total Story Points
                                fill: false, // Do not fill the area under the line
                                tension: 0.1, // Smooth the line curve
                                borderWidth: 2 // Line thickness
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'Users'
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'Story Points'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            tooltip: {
                                callbacks: {
                                    label: function (tooltipItem) {
                                        return tooltipItem.dataset.label + ': ' + tooltipItem.raw + ' Points';
                                    }
                                }
                            }
                        }
                    }
                });
            }

            // Fetch data and render all charts
            const projectId = "{{ project.ProjectID }}"; // Ensure the `project` is passed in context from backend
            const chartDataUrls = {
                donut: `/chart-data/donut/${projectId}`,
                burnup: `/chart-data/burnup/${projectId}`,
                velocity: `/chart-data/velocity/${projectId}`,
                burndown: `/chart-data/burndown/${projectId}`,
                userProgress: `/chart-data/user-progress/${projectId}`,
                userRanking: `/chart-data/user-ranking/${projectId}`
            };
            // Define chart renderers
            const chartRenderers = {
                donut: renderDonutChart,
                burnup: renderBurnupChart,
                velocity: renderVelocityChart,
                burndown: renderBurndownChart,
                userProgress: renderUserProgressChart,
                userRanking: renderUserRankingChart
            };

            for (const [chartType, url] of Object.entries(chartDataUrls)) {
                fetch(url)
                    .then(response => response.json())
                    .then(chartRenderers[chartType])
                    .catch(err => console.error(`Error loading ${chartType} chart data:`, err));
            }
        });
    </script>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const chartContainers = document.querySelectorAll(".chart-container");
        chartContainers.forEach(container => {
            const expandIcon = container.querySelector(".expand-icon");
            expandIcon.addEventListener("click", () => {
                container.classList.toggle("large");
            });
        });
    });
    </script>
</body>
</html>
